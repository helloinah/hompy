<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>동맹 배너 목록</title>
    <style>
        /* 기본 글꼴 및 패딩 설정 */
        body {
            font-family: courier, monospace; /* 글꼴: courier, monospace */
            font-size: 14px; /* 기본 글꼴 크기 */
            padding: 8px; /* 페이지 내부 여백 */
            margin: 0; /* 페이지 외부 여백 없음 */
            padding-bottom: 10rem;
        }
        /* 표 스타일 */
        table {
            width: 100%; /* 표 전체 너비 */
            margin: 0 auto; /* 표 가운데 정렬 */
            border-collapse: collapse; /* 셀 테두리 병합 */
        }
        /* 테이블 헤더(th)와 셀(td)의 기본 스타일 */
        th, td {
            text-align: left; /* 텍스트 왼쪽 정렬 */
            vertical-align: top; /* 내용 상단 정렬 */
            border-bottom: 1px solid #000; /* 하단 테두리 */
            padding: 0; /* 기본 패딩 없음 */
        }
        
        /* 표 행에 마우스를 올렸을 때 배경색 변경 */
        tr:hover {
            background-color: #fff000; /* 노란색 배경 */
        }
        
        /* 테이블 헤더 스타일 */
        th {
            font-weight: bold; /* 글꼴 굵게 */
            font-size: 0.75rem; /* 글꼴 크기 */
            padding-left: 8px; /* 왼쪽 패딩 */
            padding-bottom: 4px; /* 하단 패딩 */
        }
        /* 일반 셀의 최소 너비 */
        td {
            min-width: 90px;
            width: auto;
        }
        /* 배너 셀 스타일 */
        td.banner-cell {
            width: 90px; /* 배너 셀 너비 고정 */
            height: 30px; /* 배너 셀 높이 고정 */
            text-align: center; /* 배너 이미지 가운데 정렬 */
            overflow: hidden; /* 상자 밖으로 나가는 이미지 숨김 */
        }
        /* 배너 이미지 스타일 */
        td.banner-cell img {
            width: 90px; /* GIF 배너 너비 90px로 고정 */
            height: 30px; /* GIF 배너 높이 30px로 고정 */
            object-fit: cover; /* 이미지가 상자를 꽉 채우도록 하되, 비율 유지하며 필요시 잘림 */
            display: block; /* 블록 요소로 만들어 마진 auto 적용 가능하게 함 */
            margin: 0 auto; /* 가로 가운데 정렬 */
        }

        /* Removed .homepage-cell styles as the column is gone */
        /* '홈피 주인' 셀 스타일 */
        td.owner-cell {
            padding-left: 8px;
            padding-top: 7px;
        }
        /* '주제' 셀 스타일 */
        td.topic-cell {
            padding-left: 8px;
            padding-top: 7px;
        }
        /* '소개글' 셀 스타일 */
        td.description-cell {
            padding-left: 8px;
            padding-top: 7px;
        }

        /* --- 모바일 반응형 스타일 (Max-width 768px 이하) --- */
        @media (max-width: 500px) { /* 768px 이하 화면에 적용 */
            table {
                border-collapse: separate; /* 테이블 셀 병합 해제 */
                border-spacing: 0; /* 각 '카드' 사이의 간격 (세로) */
                padding-bottom: 2rem;
            }

            thead {
                display: none; /* 모바일에서는 테이블 헤더 숨기기 (셀이 쌓이므로 의미 없음) */
            }

            tr {
                display: flex; /* 각 행을 Flexbox 컨테이너로 만듭니다 */
                flex-wrap: wrap; /* 내용이 넘치면 다음 줄로 이동합니다 */
                border-top: 1px solid #000; /* 각 동맹 항목에 테두리 추가하여 시각적으로 구분 */
                margin-bottom: 0; /* 기존 tr 하단 마진 제거 */
            }
            
            th, td {
                display: block; /* 모든 셀을 블록 레벨 요소로 만듭니다 (기본적으로 세로로 쌓임) */
                width: auto; /* 너비 자동 조절 */
            }

            td.banner-cell {
                width: 90px; /* 배너 이미지 너비 유지 */
                height: 30px;
                flex-shrink: 0; /* 공간이 부족해도 줄어들지 않음 */
                padding-right: 0.5rem;
            }

            td.owner-cell,
            td.topic-cell {
                display: none;
            }

            td.description-cell {
                flex-grow: 1; /* 소개글 셀이 항상 전체 너비를 차지하여 다음 줄로 이동 */
                padding: 0.4rem 0;
            }
        }
    </style>
</head>
<body>
    <div style="display: flex; gap: 2rem; padding-bottom: 2rem; font-size: 0.8rem;">
    <p><a href="https://docs.google.com/document/d/14Z3Jt_uYfgDts8DDEqMbB1hn93Nu_l0-F7JoXHx-2_s" target="_blank">홈피 만드는 법</a></p>
    <p><a href="https://tally.so/r/n0YBxy" target="_blank">동맹 신청</a></p></div>
    
    <table id="bannerTable">
        <thead>
            <tr>
                <th class="banner-cell"></th> <th class="owner-cell">홈피 주인</th>
                <th class="topic-cell">주제</th>
                <th class="description-cell">소개글</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

    <script type="module">
        // utils.js에서 escapeHTML 함수를 가져옵니다.
        // 이 경로는 hompy/contents/html/ 에서 hompy/js/utils.js 로의 상대 경로입니다.
        import { escapeHTML } from '../../js/utils.js';

        /**
         * 주어진 URL이 유효하고 안전한지 검증합니다.
         * 허용된 프로토콜(http, https)만을 허용하고, JavaScript 스킴을 포함하는지 확인합니다.
         * @param {string} url 검증할 URL 문자열
         * @returns {string | null} 유효하고 안전한 URL이면 해당 URL을 반환, 아니면 null 반환.
         */
        function validateURL(url) {
            if (!url || typeof url !== 'string') {
                return null;
            }
            try {
                const parsedUrl = new URL(url);
                // http 또는 https 프로토콜만 허용합니다.
                if (parsedUrl.protocol !== 'http:' && parsedUrl.protocol !== 'https:') {
                    console.warn('Invalid protocol detected in URL:', url);
                    return null;
                }
                // 잠재적인 XSS 공격을 위해 'javascript:' 스킴을 명시적으로 차단합니다.
                // URL 객체는 'javascript:'를 프로토콜로 인식하므로, 추가적인 문자열 검사가 필요합니다.
                if (url.toLowerCase().includes('javascript:')) {
                    console.warn('JavaScript scheme detected in URL:', url);
                    return null;
                }
                return url; // 유효하고 안전한 URL 반환
            } catch (e) {
                console.warn('Invalid URL format:', url, e);
                return null; // URL 파싱 오류 시 null 반환
            }
        }

        async function parseCSV(url) {
            const tableBody = document.querySelector('#bannerTable tbody');
            if (!tableBody) {
                console.error("Table body not found.");
                return;
            }
            tableBody.innerHTML = '<tr><td colspan="2">데이터를 불러오는 중...</td></tr>';

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                const rows = text.trim().split('\n');
                
                tableBody.innerHTML = ''; // Clear loading message

                if (rows.length <= 1) { // Only header or no data
                    tableBody.innerHTML = '<tr><td colspan="2">불러올 동맹 데이터가 없습니다.</td></tr>';
                    return;
                }

                rows.forEach((row, index) => {
                    if (index === 0) return; // Skip header row
                    const columns = row.split(',').map(col => col.trim());
                    if (columns.length < 5) {
                        console.warn('Skipping malformed row:', row);
                        return; // Ensure enough columns
                    }

                    const [homepageOwner, topic, description, homepageUrl, bannerGifUrl] = columns;

                    // 1. URL 검증
                    const validatedHomepageUrl = validateURL(homepageUrl);
                    const validatedBannerGifUrl = validateURL(bannerGifUrl);

                    const tr = document.createElement('tr');
                    
                    const imgTd = document.createElement('td');
                    const img = document.createElement('img');
                    
                    // 유효성 검사를 통과한 URL만 사용
                    if (validatedBannerGifUrl) {
                        img.src = validatedBannerGifUrl;
                    } else {
                        img.src = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='; // 투명한 1x1 GIF
                        console.warn(`Invalid banner URL for ${homepageOwner}: ${bannerGifUrl}. Using placeholder.`);
                    }
                    // 2. homepageOwner를 escapeHTML로 이스케이프하여 alt 속성 설정
                    img.alt = escapeHTML(homepageOwner || '') + ' 배너'; 
                    imgTd.appendChild(img);
                    tr.appendChild(imgTd);

                    const textTd = document.createElement('td');
                    const ownerDiv = document.createElement('div');
                    ownerDiv.textContent = escapeHTML(homepageOwner || '');
                    textTd.appendChild(ownerDiv);

                    const topicDiv = document.createElement('div');
                    topicDiv.textContent = escapeHTML(topic || '');
                    textTd.appendChild(topicDiv);

                    const descriptionDiv = document.createElement('div'); // descriptionTd -> descriptionDiv
                    descriptionDiv.textContent = escapeHTML(description || '');
                    textTd.appendChild(descriptionDiv);

                    tr.appendChild(textTd);

                    // 3. homepageUrl에 대한 유효성 검사를 통과한 경우에만 onclick 이벤트 할당
                    if (validatedHomepageUrl) {
                        tr.onclick = () => {
                            window.open(validatedHomepageUrl, '_blank', 'noopener,noreferrer');
                        };
                    } else {
                        console.warn(`Invalid homepage URL for ${homepageOwner}: ${homepageUrl}. Link disabled.`);
                        tr.style.cursor = 'default'; // 클릭 비활성화 시 커서 변경
                    }

                    tableBody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error parsing CSV:', error);
                tableBody.innerHTML = '<tr><td colspan="2" class="error-message">동맹 목록을 불러오지 못했습니다. 오류: ' + escapeHTML(error.message) + '</td></tr>';
            }
        }

        // 페이지 로드 시 CSV 파싱 함수 호출
        document.addEventListener('DOMContentLoaded', () => {
            const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRzTfN6pP6r106GzGj0m4n_H4f5jRjYnF0ZzZzZzZzZzZzZzZzZzZzZzZzZzZzZzZz/pub?gid=0&single=true&output=csv'; // 실제 CSV URL로 변경
            parseCSV(csvUrl);
        });
    </script>

</body>
</html>